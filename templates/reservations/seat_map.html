{% extends "base_auth.html" %}

{% block title %}{{ performance.title }} ì¢Œì„ ì„ íƒ{% endblock %}

{% block extra_head %}
<style>
    .auth-wrapper {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 32px 16px;
    }

    .seat-page {
        width: 100%;
        max-width: 1080px;
        color: #e5e7eb;
    }

    .seat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .seat-title {
        font-size: 20px;
        font-weight: 700;
    }
    .seat-datetime {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 4px;
    }

    .seat-header-right {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: #9ca3af;
    }

    .btn-ghost {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.8);
        background: rgba(15,23,42,0.9);
        color: #e5e7eb;
        font-size: 12px;
        text-decoration: none;
    }
    .btn-ghost:hover {
        background: rgba(30,64,175,0.9);
    }

    .seat-layout {
        display: grid;
        grid-template-columns: minmax(0, 2.3fr) minmax(0, 1fr);
        gap: 18px;
    }

    .seat-main-card,
    .seat-side-card {
        background: rgba(15,23,42,0.96);
        border-radius: 20px;
        border: 1px solid rgba(148,163,184,0.45);
        padding: 16px 16px 14px;
        box-shadow:
            0 18px 40px rgba(15,23,42,0.9),
            0 0 0 1px rgba(15,23,42,0.9);
    }

    .stage-box {
        text-align: center;
        padding: 10px 0;
        margin-bottom: 10px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.7);
        background: linear-gradient(135deg, #020617, #0f172a);
        font-size: 12px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #9ca3af;
    }

    .seat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(48px, 1fr));
        gap: 8px;
        justify-items: center;
    }

    .seat {
        width: 100%;
        max-width: 70px;
        border-radius: 14px;
        padding: 7px 0;
        border: 1px solid rgba(148,163,184,0.6);
        background: rgba(15,23,42,0.95);
        font-size: 12px;
        color: #e5e7eb;
        cursor: pointer;
        text-align: center;
        transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }

    .seat-available {
        border-color: rgba(74,222,128,0.9);
        background: radial-gradient(circle at 0% 0%, rgba(34,197,94,0.35), rgba(15,23,42,0.98));
    }
    .seat-available:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(34,197,94,0.45);
    }

    .seat-hold {
        border-color: rgba(251,191,36,0.95);
        background: rgba(30,64,175,0.85);
        color: #fef9c3;
        cursor: default;
    }

    .seat-confirmed {
        border-color: rgba(248,113,113,0.95);
        background: rgba(127,29,29,0.96);
        color: #fee2e2;
        cursor: default;
    }

    .seat:disabled {
        opacity: 0.8;
        cursor: default;
        box-shadow: none;
        transform: none;
    }

    .seat-side-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .seat-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 11px;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .legend-dot {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.7);
    }
    .legend-dot.available {
        border-color: rgba(74,222,128,0.9);
        background: radial-gradient(circle at 0% 0%, rgba(34,197,94,0.4), rgba(15,23,42,0.98));
    }
    .legend-dot.hold {
        border-color: rgba(251,191,36,0.95);
        background: rgba(30,64,175,0.85);
    }
    .legend-dot.confirmed {
        border-color: rgba(248,113,113,0.95);
        background: rgba(127,29,29,0.96);
    }

    .seat-notice {
        font-size: 11px;
        color: #9ca3af;
        line-height: 1.5;
    }

    @media (max-width: 880px) {
        .seat-layout {
            grid-template-columns: minmax(0, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="seat-page">
    <header class="seat-header">
        <div>
            <div class="seat-title">{{ performance.title }}</div>
            <div class="seat-datetime">
                {{ performance.start_at|date:"Y.m.d (D)" }}
                Â· {{ performance.start_at|time:"H:i" }} ~ {{ performance.end_at|time:"H:i" }}
            </div>
        </div>

        <div class="seat-header-right">
            <span>{{ request.user.real_name }} ë‹˜</span>
            <a href="{% url 'reservations:performance_list' %}" class="btn-ghost">ê³µì—° ëª©ë¡</a>
            <form method="post"
                action="{% url 'logout' %}"
                style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn-ghost logout-btn">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </form>
        </div>
    </header>

    <div class="seat-layout">
        <section class="seat-main-card">
            <div class="stage-box">STAGE</div>

            <div class="seat-grid">
                {% for seat in seats %}
                    <button
                        class="seat
                        {% if not seat.reservation or seat.reservation.status == 'CANCELLED' %}
                            seat-available
                        {% elif seat.reservation.status == 'HOLD' %}
                            seat-hold
                        {% elif seat.reservation.status == 'CONFIRMED' %}
                            seat-confirmed
                        {% endif %}
                        "
                        data-seat-id="{{ seat.id }}"
                        data-label="{{ seat.row }}{{ seat.number }}"
                        data-reserve-url="{% url 'reservations:reserve_seat' performance.id seat.id %}"
                        data-expires-at="{% if seat.reservation and seat.reservation.status == 'HOLD' and seat.reservation.expires_at %}{{ seat.reservation.expires_at|date:'c' }}{% endif %}"
                        {% if seat.reservation and seat.reservation.status != 'CANCELLED' %}
                            disabled
                        {% endif %}
                    >
                        {{ seat.row }}{{ seat.number }}
                    </button>
                {% empty %}
                    <p>ë“±ë¡ëœ ì¢Œì„ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ì¢Œì„ì„ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”.</p>
                {% endfor %}
            </div>
        </section>

        <aside class="seat-side-card">
            <div class="seat-side-title">ì¢Œì„ ìƒíƒœ ì•ˆë‚´</div>
            <div class="seat-legend">
                <span class="legend-item">
                    <span class="legend-dot available"></span> ì˜ˆì•½ ê°€ëŠ¥
                </span>
                <span class="legend-item">
                    <span class="legend-dot hold"></span> ì„ì‹œ í™€ë“œ(ê²°ì œ ì§„í–‰ ì¤‘)
                </span>
                <span class="legend-item">
                    <span class="legend-dot confirmed"></span> ì˜ˆì•½ í™•ì •
                </span>
            </div>

            <div class="seat-notice">
                Â· ì¢Œì„ì„ ì„ íƒí•˜ë©´ <strong>1ë¶„ê°„ ì„ì‹œ í™€ë“œ</strong> ë©ë‹ˆë‹¤.<br/>
                Â· ì„ì‹œ í™€ë“œ ì‹œê°„ ë‚´ì— ê²°ì œê°€ ì™„ë£Œë˜ì§€ ì•Šìœ¼ë©´ ì¢Œì„ì´ ìë™ í•´ì œë©ë‹ˆë‹¤.<br/>
                Â· í•œ ê³„ì •ë‹¹ ì—¬ëŸ¬ ì¢Œì„ ì •ì±…, ì‹¤ì œ ê²°ì œ ì—°ë™ ë“±ì€
                  ì´í›„ ë‹¨ê³„ì—ì„œ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </aside>
    </div>
</div>

<script>
(function () {
    var csrfToken = '{{ csrf_token }}';
    var grid = document.querySelector('.seat-grid');
    if (!grid) return;

    // ì¢Œì„ë³„ ë§Œë£Œ íƒ€ì´ë¨¸ ì €ì¥ìš©
    var seatTimers = {};

    // íŠ¹ì • ì¢Œì„ì— ë§Œë£Œ íƒ€ì´ë¨¸ ì„¤ì •
    function scheduleSeatExpiry(btn, seatId, expiresAt) {
        // ê¸°ì¡´ íƒ€ì´ë¨¸ ìˆìœ¼ë©´ ì •ë¦¬
        if (seatTimers[seatId]) {
            clearTimeout(seatTimers[seatId]);
            seatTimers[seatId] = null;
        }

        if (!expiresAt) {
            return;
        }

        var target = new Date(expiresAt);
        if (isNaN(target.getTime())) {
            return;
        }

        var now = new Date();
        var diff = target.getTime() - now.getTime();

        // ì´ë¯¸ ë§Œë£Œëœ ì‹œê°„ì´ë©´ ë°”ë¡œ ì˜ˆì•½ ê°€ëŠ¥ìœ¼ë¡œ ëŒë¦¬ê¸°
        if (diff <= 0) {
            btn.classList.remove('seat-hold', 'seat-confirmed');
            btn.classList.add('seat-available');
            btn.disabled = false;
            return;
        }

        // diff ms í›„ì— ì˜ˆì•½ ê°€ëŠ¥ ìƒíƒœë¡œ ì „í™˜
        seatTimers[seatId] = setTimeout(function () {
            btn.classList.remove('seat-hold', 'seat-confirmed');
            btn.classList.add('seat-available');
            btn.disabled = false;
            seatTimers[seatId] = null;
        }, diff);
    }

    // í˜ì´ì§€ ì²˜ìŒ ë¡œë”© ì‹œ ì´ë¯¸ HOLDì¸ ì¢Œì„ë“¤ì— ëŒ€í•´ íƒ€ì´ë¨¸ ì„¤ì •
    var seatButtons = grid.querySelectorAll('.seat');
    for (var i = 0; i < seatButtons.length; i++) {
        var b = seatButtons[i];
        var sid = b.getAttribute('data-seat-id');
        var exp = b.getAttribute('data-expires-at');
        if (exp) {
            scheduleSeatExpiry(b, sid, exp);
        }
    }

    // âœ… 1) ì¢Œì„ í´ë¦­ ì‹œ ì˜ˆì•½ ìš”ì²­ (fetch)
    grid.addEventListener('click', function (e) {
        var btn = e.target;
        if (!btn.classList.contains('seat')) return;
        if (!btn.classList.contains('seat-available')) return; // ì˜ˆì•½ ê°€ëŠ¥ ì¢Œì„ë§Œ

        var label = btn.getAttribute('data-label');
        if (!confirm(label + ' ì¢Œì„ì„ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        var url = btn.getAttribute('data-reserve-url');
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function (res) { return res.json(); })
        .then(function (data) {
            if (data.ok) {
                alert('ì¢Œì„ì´ 1ë¶„ê°„ ì„ì‹œ í™€ë“œë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ğŸ”¥ ë‚´ ë¸Œë¼ìš°ì €ëŠ” WebSocket ì•ˆ ê¸°ë‹¤ë¦¬ê³  ë°”ë¡œ HOLD ìƒíƒœë¡œ ë³€ê²½
                btn.classList.remove('seat-available', 'seat-confirmed');
                btn.classList.add('seat-hold');
                btn.disabled = true;

                // ì‘ë‹µì— ì˜¨ expires_at ê¸°ì¤€ìœ¼ë¡œ íƒ€ì´ë¨¸ ì„¤ì •
                if (data.expires_at) {
                    var seatId = btn.getAttribute('data-seat-id');
                    scheduleSeatExpiry(btn, seatId, data.expires_at);
                }
            } else {
                alert(data.message || 'ì˜ˆì•½ ì‹¤íŒ¨');
            }
        })
        .catch(function () {
            alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    });

    // âœ… 2) WebSocket ì—°ê²° ì„¤ì • (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    var performanceId = {{ performance.id }};
    var scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    var wsUrl = scheme + '://' + window.location.host +
        '/ws/reservations/performance/' + performanceId + '/';

    var socket = new WebSocket(wsUrl);

    socket.onopen = function () {
        console.log('Seat WebSocket connected');
    };

    socket.onclose = function () {
        console.log('Seat WebSocket disconnected');
    };

    socket.onerror = function (e) {
        console.log('WebSocket error', e);
    };

    // âœ… 3) ì„œë²„ì—ì„œ ì¢Œì„ ìƒíƒœ ë³€ê²½ ë©”ì‹œì§€ ë°›ì•˜ì„ ë•Œ DOM ì—…ë°ì´íŠ¸
    socket.onmessage = function (e) {
        try {
            var data = JSON.parse(e.data);
        } catch (err) {
            console.log('Invalid WS data', e.data);
            return;
        }

        var seatId = data.seat_id;
        var status = data.status;           // null / 'HOLD' / 'CONFIRMED' / 'CANCELLED'
        var expiresAt = data.expires_at || null;

        var btn = document.querySelector('.seat[data-seat-id="' + seatId + '"]');
        if (!btn) return;

        // ì´ ì¢Œì„ì— ê±¸ë ¤ ìˆë˜ ê¸°ì¡´ íƒ€ì´ë¨¸ ì œê±°
        if (seatTimers[seatId]) {
            clearTimeout(seatTimers[seatId]);
            seatTimers[seatId] = null;
        }

        // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
        btn.classList.remove('seat-available', 'seat-hold', 'seat-confirmed');
        btn.disabled = false;

        // ìƒíƒœì— ë”°ë¼ ë‹¤ì‹œ ì ìš©
        if (!status || status === 'CANCELLED') {
            // ì˜ˆì•½ ê°€ëŠ¥
            btn.classList.add('seat-available');
            btn.disabled = false;
        } else if (status === 'HOLD') {
            btn.classList.add('seat-hold');
            btn.disabled = true;
            // WebSocketìœ¼ë¡œë„ HOLD ìƒíƒœê°€ ì˜¤ë©´, ì—¬ê¸°ì„œ íƒ€ì´ë¨¸ ì„¤ì •
            if (expiresAt) {
                scheduleSeatExpiry(btn, seatId, expiresAt);
            }
        } else if (status === 'CONFIRMED') {
            btn.classList.add('seat-confirmed');
            btn.disabled = true;
        }
    };
})();
</script>

{% endblock %}
